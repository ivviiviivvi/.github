name: Mutation Testing

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
  - cron: 0 2 * * 0
  workflow_dispatch:
    inputs:
      mutant_threshold:
        description: Minimum mutation score (0-100)
        required: false
        default: '80'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write

jobs:
  javascript-mutation:
    name: JavaScript Mutation Testing
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Check prerequisites
      id: check-js
      run: |
        has_pkg=false
        has_src=false
        if [ -f "package.json" ]; then has_pkg=true; fi
        if compgen -G "src/**/*.js" > /dev/null 2>&1 || compgen -G "src/**/*.ts" > /dev/null 2>&1; then has_src=true; fi
        if [ "$has_pkg" = "true" ] && [ "$has_src" = "true" ]; then
          echo "should_run=true" >> $GITHUB_OUTPUT
        else
          echo "should_run=false" >> $GITHUB_OUTPUT
        fi

    - name: Setup Node.js
      if: steps.check-js.outputs.should_run == 'true'
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # ratchet:actions/setup-node@v4
      with:
        node-version: '20'
        cache: npm

    - name: Install dependencies
      if: steps.check-js.outputs.should_run == 'true'
      run: npm ci

    - name: Install Stryker
      if: steps.check-js.outputs.should_run == 'true'
      run: npm install --save-dev @stryker-mutator/core

    - name: Create Stryker config
      if: steps.check-js.outputs.should_run == 'true'
      run: |
        cat > stryker.conf.json << 'EOF'
        {
          "$schema": "./node_modules/@stryker-mutator/core/schema/stryker-schema.json",
          "packageManager": "npm",
          "reporters": [
            "html",
            "clear-text",
            "progress",
            "json"
          ],
          "testRunner": "jest",
          "coverageAnalysis": "perTest",
          "mutate": [
            "src/**/*.js",
            "!src/**/*.test.js",
            "!src/**/*.spec.js"
          ],
          "thresholds": {
            "high": 80,
            "low": 60,
            "break": 50
          },
          "timeoutMS": 60000,
          "maxConcurrentTestRunners": 4
        }
        EOF

    - name: Run Stryker Mutation Testing
      if: steps.check-js.outputs.should_run == 'true'
      run: npx stryker run
      continue-on-error: true

    - name: Parse Mutation Score
      if: steps.check-js.outputs.should_run == 'true'
      id: mutation
      run: |
        if [ -f "reports/mutation/mutation.json" ]; then
          SCORE=$(jq -r '.mutationScore' reports/mutation/mutation.json)
          echo "score=$SCORE" >> $GITHUB_OUTPUT
        else
          echo "score=0" >> $GITHUB_OUTPUT
        fi

    - name: Upload Mutation Report
      if: steps.check-js.outputs.should_run == 'true'
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # ratchet:actions/upload-artifact@v4
      with:
        name: mutation-report-javascript
        path: reports/mutation/
        retention-days: 30

    - name: Comment on commit
      if: steps.check-js.outputs.should_run == 'true' && github.event_name == 'workflow_dispatch'
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b  # ratchet:actions/github-script@v7
      with:
        script: |
          const score = '${{ steps.mutation.outputs.score }}';
          const threshold = ${{ inputs.mutant_threshold || 80 }};

          const message = `## ðŸ§¬ Mutation Testing Results (JavaScript)

          **Mutation Score**: ${score}%
          **Threshold**: ${threshold}%
          **Status**: ${score >= threshold ? 'âœ… PASS' : 'âŒ FAIL'}

          ### What is Mutation Testing?

          Mutation testing validates the quality of your tests by introducing small changes (mutations) to your code and checking if tests catch them.

          - **Killed**: Tests caught the mutation âœ…
          - **Survived**: Mutation wasn't detected âŒ
          - **Timeout**: Tests took too long
          - **No Coverage**: Code not tested

          **Goal**: Higher mutation score = better test quality

          [View Full Report](../actions/runs/${{ github.run_id }})
          `;

          console.log(message);

  python-mutation:
    name: Python Mutation Testing
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Check prerequisites
      id: check-py
      run: |
        has_config=false
        has_src=false
        if [ -f "requirements.txt" ] || [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then has_config=true; fi
        if compgen -G "src/**/*.py" > /dev/null 2>&1; then has_src=true; fi
        if [ "$has_config" = "true" ] && [ "$has_src" = "true" ]; then
          echo "should_run=true" >> $GITHUB_OUTPUT
        else
          echo "should_run=false" >> $GITHUB_OUTPUT
        fi

    - name: Setup Python
      if: steps.check-py.outputs.should_run == 'true'
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: pip

    - name: Install dependencies
      if: steps.check-py.outputs.should_run == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install mutmut

    - name: Run mutmut
      if: steps.check-py.outputs.should_run == 'true'
      run: |
        mutmut run --paths-to-mutate=src/ || true

    - name: Generate HTML report
      if: steps.check-py.outputs.should_run == 'true'
      run: mutmut junitxml > mutmut-results.xml || true

    - name: Mutmut Results
      if: steps.check-py.outputs.should_run == 'true'
      run: mutmut results || true

    - name: Upload Results
      if: steps.check-py.outputs.should_run == 'true'
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # ratchet:actions/upload-artifact@v4
      with:
        name: mutation-report-python
        path: |
          mutmut-results.xml
          .mutmut-cache
        retention-days: 30

  mutation-summary:
    name: Mutation Testing Summary
    needs: [javascript-mutation, python-mutation]
    # Only run summary if at least one mutation test ran
    if: always() && (needs.javascript-mutation.result != 'skipped' || needs.python-mutation.result != 'skipped')
    runs-on: ubuntu-latest
    steps:
    - name: Generate Summary
      run: |
        echo "## ðŸ§¬ Mutation Testing Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Language | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| JavaScript | ${{ needs.javascript-mutation.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Python | ${{ needs.python-mutation.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### What to do next?" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. Review survived mutants" >> $GITHUB_STEP_SUMMARY
        echo "2. Add tests to catch mutations" >> $GITHUB_STEP_SUMMARY
        echo "3. Aim for >80% mutation score" >> $GITHUB_STEP_SUMMARY
