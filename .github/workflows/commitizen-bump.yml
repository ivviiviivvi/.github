# Automated version bumping using Commitizen
# Analyzes conventional commits to determine semantic version bump
name: Commitizen Bump

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: Bump type
        required: false
        type: choice
        options:
        - auto
        - patch
        - minor
        - major
        default: auto
      dry_run:
        description: Dry run (no commits/tags)
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  bump:
    name: Version Bump
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: pip

    - name: Install Commitizen
      run: pip install commitizen

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Run Version Bump
      id: bump
      env:
        BUMP_TYPE: ${{ inputs.bump_type }}
        DRY_RUN: ${{ inputs.dry_run }}
      run: |
        ARGS="--changelog"

        if [ "$BUMP_TYPE" != "auto" ]; then
          ARGS="$ARGS --increment $BUMP_TYPE"
        fi

        if [ "$DRY_RUN" == "true" ]; then
          ARGS="$ARGS --dry-run"
          echo "Running in dry-run mode..."
        fi

        echo "Running: cz bump $ARGS"
        cz bump $ARGS || {
          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 21 ]; then
            echo "No commits found that would trigger a version bump"
            exit 0
          fi
          exit $EXIT_CODE
        }

    - name: Push Changes
      if: inputs.dry_run == false
      run: |
        git push origin HEAD
        git push origin --tags

    - name: Get New Version
      id: version
      run: |
        VERSION=$(cz version --project)
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"
        echo "New version: $VERSION"

    - name: Create Summary
      env:
        BUMP_TYPE: ${{ inputs.bump_type }}
        DRY_RUN: ${{ inputs.dry_run }}
      run: |
        VERSION=$(cz version --project)
        {
          echo "## Version Bump Summary"
          echo ""
          echo "**New Version:** \`v$VERSION\`"
          echo ""
          echo "**Bump Type:** $BUMP_TYPE"
          echo ""
          echo "**Dry Run:** $DRY_RUN"
          echo ""
          if [ "$DRY_RUN" == "false" ]; then
            echo "### Next Steps"
            echo "- Create a release from the new tag"
            echo "- Review the updated CHANGELOG.md"
          fi
        } >> "$GITHUB_STEP_SUMMARY"
